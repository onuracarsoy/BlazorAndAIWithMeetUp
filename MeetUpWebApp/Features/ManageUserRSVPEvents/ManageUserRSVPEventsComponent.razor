@page "/users/{userId:int}/manage-rsvp-events"
@inherits BaseComponent
@inject ManageUserRSVPEventsService manageUserRSVPEventsService
@attribute [Authorize(policy: "SameUserPolicy")]

<h3>Etkinliklerim</h3>

<div class="container my-3">
    <div class="card shadow-sm">
        <div class="card-body">

            @*   <div class="text-center py-4">
                    <div class="spinner-border text-primary" role="status"></div>
                </div> *@

            @if (pastEvents is not null && pastEvents.Count > 0 || upcomingEvents is not null && upcomingEvents.Count > 0)
            {
                <ul class="nav nav-tabs" id="myTab" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="home-tab" data-bs-toggle="tab" data-bs-target="#home" type="button" role="tab" aria-controls="home" aria-selected="true">Yaklaşan Etkinliklerim</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="profile-tab" data-bs-toggle="tab" data-bs-target="#profile" type="button" role="tab" aria-controls="profile" aria-selected="false">Geçmiş Etkinliklerim</button>
                    </li>

                </ul>
                <div class="tab-content" id="myTabContent">
                    <div class="tab-pane fade show active" id="home" role="tabpanel" aria-labelledby="home-tab">
                        @if (upcomingEvents is not null && upcomingEvents.Count > 0)
                        {

                            <div class="table-responsive">
                                <table class="table table-hover align-middle">
                                    <thead class="table-light">
                                        <tr>
                                            <th></th>
                                            <th>Etkinlik</th>
                                            <th>Tarih / Saat</th>
                                            <th>Tür</th>
                                            <th>Yer/Link</th>
                                            <th>Kontenjan</th>
                                            <th class="text-end">İşlemler</th>
                                        </tr>
                                    </thead>
                                    <tbody>

                                        @foreach (var item in upcomingEvents)
                                        {
                                            <tr>
                                                <td style="width:100px">
                                                    <img src="@item.ImageUrl" alt="kapak" class="rounded" style="max-height:100px;" />
                                                </td>
                                                <td>
                                                    <strong>@item.Title</strong>
                                                    <div class="small text-muted"></div>
                                                </td>
                                                <td class="small">@item.BeginDate @item.BeginTime - @item.EndDate @item.EndTime</td>
                                                <td class="small">@((item.Category == "InPerson") ? "Yüzyüze" : "Çevrimçi")</td>
                                                <td class="small">@((item.Category == "InPerson") ? item.Location : item.MeetupLink)</td>
                                                <td class="small">@(item.Capacity == 0 ? "Sınırsız" : item.Capacity.ToString())</td>
                                                <td class="text-end">
                                                    <a class="btn btn-sm btn-primary me-1" href="/events/@item.EventId">
                                                        <i class="bi bi-eye"></i> Görüntüle
                                                    </a>
                                                    <button class="btn btn-sm btn-danger">
                                                        <i class="bi bi-x-circle"></i> Kaydı İptal Et
                                                    </button>
                                                </td>
                                            </tr>
                                        }


                                    </tbody>
                                </table>
                            </div>
                        }
                        else
                        {
                            <div class="text-center py-4 text-muted">
                                <i class="bi bi-calendar-x" style="font-size: 1.5rem"></i>
                                <div>Yaklaşan bir etkinliğiniz yok.</div>
                                <div class="mt-2">
                                    <a class="btn btn-sm btn-success" href="/">Etkinliklere Göz At</a>
                                </div>
                            </div>
                        }
                    </div>
                    <div class="tab-pane fade" id="profile" role="tabpanel" aria-labelledby="profile-tab">
                        @if (pastEvents is not null && pastEvents.Count > 0)
                        {

                            <div class="table-responsive">
                                <table class="table table-hover align-middle">
                                    <thead class="table-light">
                                        <tr>
                                            <th></th>
                                            <th>Etkinlik</th>
                                            <th>Tarih / Saat</th>
                                            <th>Tür</th>
                                            <th>Yer/Link</th>
                                            <th>Kontenjan</th>
                                            <th class="text-end">İşlemler</th>
                                        </tr>
                                    </thead>
                                    <tbody>

                                        @foreach (var item in pastEvents)
                                        {
                                            <tr>
                                                <td style="width:100px">
                                                    <img src="@item.ImageUrl" alt="kapak" class="rounded" style="max-height:100px;" />
                                                </td>
                                                <td>
                                                    <strong>@item.Title</strong>
                                                    <div class="small text-muted"></div>
                                                </td>
                                                <td class="small">@item.BeginDate @item.BeginTime - @item.EndDate @item.EndTime</td>
                                                <td class="small">@((item.Category == "InPerson") ? "Yüzyüze" : "Çevrimçi")</td>
                                                <td class="small">@((item.Category == "InPerson") ? item.Location : item.MeetupLink)</td>
                                                <td class="small">@(item.Capacity == 0 ? "Sınırsız" : item.Capacity.ToString())</td>
                                                <td class="text-end">
                                                    <a class="btn btn-sm btn-primary me-1" href="/events/@item.EventId">
                                                        Görüntüle
                                                    </a>

                                                    <button class="btn btn-sm  btn-danger">
                                                         Kaydı İptal Et
                                                    </button>
                                                </td>
                                            </tr>
                                        }


                                    </tbody>
                                </table>
                            </div>
                        }
                        else
                        {
                            <div class="text-center py-4 text-muted">
                                <i class="bi bi-calendar-x" style="font-size: 1.5rem"></i>
                                <div>Geçmiş bir etkinliğiniz yok.</div>

                            </div>
                        }


                    </div>

                </div>

            }
            else
            {
                <div class="text-center py-4 text-muted">
                    <i class="bi bi-calendar-x" style="font-size: 1.5rem"></i>
                    <div>Henüz kayıtlı olduğunuz bir etkinlik yok.</div>
                    <div class="mt-2">
                        <a class="btn btn-sm btn-success" href="/">Etkinliklere Göz At</a>
                    </div>
                </div>

            }

        </div>
    </div>
</div>

@code {
    [Parameter]
    public int userId { get; set; }

    private List<EventViewModel> eventViewModel = new List<EventViewModel>();
    private List<EventViewModel> upcomingEvents = new List<EventViewModel>();
    private List<EventViewModel> pastEvents = new List<EventViewModel>();

    protected override async Task OnParametersSetAsync()
    {
        eventViewModel = await manageUserRSVPEventsService.GetUserRSVPEventsAsync(userId);

        var now = DateTime.Now;

        upcomingEvents = eventViewModel
            .Where(e => e.BeginDate.ToDateTime(e.BeginTime) > now)
            .ToList();

        pastEvents = eventViewModel
            .Where(e => e.BeginDate.ToDateTime(e.BeginTime) <= now)
            .ToList();
    }


}


